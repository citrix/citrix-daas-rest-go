// Copyright Â© 2025. Citrix Systems, Inc.

package test

import (
	"context"
	"net/http"
	"testing"

	"github.com/citrix/citrix-daas-rest-go/citrixorchestration"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"
	"github.com/stretchr/testify/require"
)

func Test_citrixorchestration_ZonesAPIsDAASService(t *testing.T) {
	t.Run("Test ZonesGetZone Success", func(t *testing.T) {
		nameOrId := "test-zone-id-autogenerated"

		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		mockZone := &citrixorchestration.ZoneDetailResponseModel{
			Id:        nameOrId,
			Name:      nameOrId,
			IsPrimary: true,
		}
		mockAPI.On("ZonesGetZoneExecute", mock.Anything).Return(mockZone, &http.Response{StatusCode: 200}, nil)

		// Execute
		request := mockAPI.ZonesGetZone(context.Background(), nameOrId)
		resp, httpRes, err := request.Execute()

		// Assert
		require.Nil(t, err)
		require.NotNil(t, resp)
		assert.Equal(t, 200, httpRes.StatusCode)
		assert.Equal(t, nameOrId, resp.Id)
	})

	t.Run("Test ZonesGetZone Error", func(t *testing.T) {
		nameOrId := "test-zone-error"
		expectedError := assert.AnError

		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		mockAPI.On("ZonesGetZoneExecute", mock.Anything).Return((*citrixorchestration.ZoneDetailResponseModel)(nil), &http.Response{StatusCode: 500}, expectedError)

		request := mockClient.APIClient.ZonesAPIsDAAS.ZonesGetZone(context.Background(), nameOrId)
		resp, httpRes, err := request.Execute()

		assert.Equal(t, expectedError, err)
		assert.Nil(t, resp)
		assert.NotNil(t, httpRes)
		assert.Equal(t, 500, httpRes.StatusCode)
	})

	t.Run("Test ZonesGetZone Multiple Calls Same Zone", func(t *testing.T) {
		nameOrId := "test-zone-id-autogenerated"
		expectedError := assert.AnError

		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		mockZone := &citrixorchestration.ZoneDetailResponseModel{
			Id:        nameOrId,
			Name:      nameOrId,
			IsPrimary: true,
		}
		mockAPI.On("ZonesGetZoneExecute", mock.Anything).Return(mockZone, &http.Response{StatusCode: 200}, nil).Once()
		mockAPI.On("ZonesGetZoneExecute", mock.Anything).Return((*citrixorchestration.ZoneDetailResponseModel)(nil), &http.Response{StatusCode: 500}, expectedError).Once()

		// Execute first call
		request := mockAPI.ZonesGetZone(context.Background(), nameOrId)
		resp, httpRes, err := request.Execute()

		// Assert
		require.Nil(t, err)
		require.NotNil(t, resp)
		assert.Equal(t, 200, httpRes.StatusCode)
		assert.Equal(t, nameOrId, resp.Id)

		// Execute second call with same request
		resp, httpRes, err = request.Execute()

		// Assert the error happened the 2nd time
		assert.Equal(t, expectedError, err)
		assert.Nil(t, resp)
		assert.NotNil(t, httpRes)
		assert.Equal(t, 500, httpRes.StatusCode)
	})

	t.Run("Test ZonesGetZone Different Responses By Input", func(t *testing.T) {
		// Demonstrates returning different responses based on input
		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		zone1 := &citrixorchestration.ZoneDetailResponseModel{
			Id:        "zone-1",
			Name:      "Zone One",
			IsPrimary: true,
		}
		// Match using mock.MatchedBy - useful for complex validation
		mockAPI.On("ZonesGetZoneExecute", mock.MatchedBy(func(req citrixorchestration.ApiZonesGetZoneRequest) bool {
			// Use the Mock<Api>Request wrapper to access request parameters
			mockReq := citrixorchestration.MockApiZonesGetZoneRequest{ApiZonesGetZoneRequest: req}
			return mockReq.GetNameOrId() == "zone-1"
		})).Return(zone1, &http.Response{StatusCode: 200}, nil)

		zone2 := &citrixorchestration.ZoneDetailResponseModel{
			Id:        "zone-2",
			Name:      "Zone Two",
			IsPrimary: false,
		}

		mockAPI.On("ZonesGetZoneExecute", mock.MatchedBy(func(req citrixorchestration.ApiZonesGetZoneRequest) bool {
			// Use the Mock<Api>Request wrapper to access request parameters
			mockReq := citrixorchestration.MockApiZonesGetZoneRequest{ApiZonesGetZoneRequest: req}
			return mockReq.GetNameOrId() == "zone-2"
		})).Return(zone2, &http.Response{StatusCode: 200}, nil)

		// Execute zone-2's call first to show we aren't just matching sequential calls accidentally
		resp2, httpRes2, err2 := mockAPI.ZonesGetZone(context.Background(), "zone-2").Execute()
		require.Nil(t, err2)
		assert.Equal(t, "Zone Two", resp2.Name)
		assert.False(t, resp2.IsPrimary)
		assert.Equal(t, 200, httpRes2.StatusCode)

		// Execute zone-1's call
		resp1, httpRes1, err1 := mockAPI.ZonesGetZone(context.Background(), "zone-1").Execute()
		require.Nil(t, err1)
		assert.Equal(t, "Zone One", resp1.Name)
		assert.True(t, resp1.IsPrimary)
		assert.Equal(t, 200, httpRes1.StatusCode)
	})

	t.Run("Test ZonesGetZone Verify Call Count", func(t *testing.T) {
		// Demonstrates verifying a method was called a specific number of times
		nameOrId := "test-zone"

		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		mockZone := &citrixorchestration.ZoneDetailResponseModel{
			Id:   nameOrId,
			Name: nameOrId,
		}

		// Expect exactly 3 calls
		mockAPI.On("ZonesGetZoneExecute", mock.Anything).Return(mockZone, &http.Response{StatusCode: 200}, nil).Times(3)

		// Make 3 calls
		for i := 0; i < 3; i++ {
			resp, httpRes, err := mockAPI.ZonesGetZone(context.Background(), nameOrId).Execute()
			require.Nil(t, err)
			require.NotNil(t, resp)
			assert.Equal(t, 200, httpRes.StatusCode)
		}

		mockAPI.AssertNumberOfCalls(t, "ZonesGetZoneExecute", 3)
	})

	t.Run("Test ZonesGetZone Retry Logic Simulation", func(t *testing.T) {
		// Demonstrates simulating retry logic - first call fails, second succeeds
		nameOrId := "retry-zone"

		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		mockZone := &citrixorchestration.ZoneDetailResponseModel{
			Id:   nameOrId,
			Name: nameOrId,
		}

		// First call: temporary failure
		mockAPI.On("ZonesGetZoneExecute", mock.Anything).
			Return((*citrixorchestration.ZoneDetailResponseModel)(nil), &http.Response{StatusCode: 503}, assert.AnError).Once()

		// Second call: success after retry
		mockAPI.On("ZonesGetZoneExecute", mock.Anything).
			Return(mockZone, &http.Response{StatusCode: 200}, nil).Once()

		// First attempt fails
		resp1, httpRes1, err1 := mockAPI.ZonesGetZone(context.Background(), nameOrId).Execute()
		assert.NotNil(t, err1)
		assert.Nil(t, resp1)
		assert.Equal(t, 503, httpRes1.StatusCode)

		// Retry succeeds
		resp2, httpRes2, err2 := mockAPI.ZonesGetZone(context.Background(), nameOrId).Execute()
		require.Nil(t, err2)
		require.NotNil(t, resp2)
		assert.Equal(t, 200, httpRes2.StatusCode)
		assert.Equal(t, nameOrId, resp2.Id)
	})

	t.Run("Test ZonesGetZone With Custom Assertion", func(t *testing.T) {
		// Demonstrates using Run() to perform custom logic and assertions
		nameOrId := "custom-zone"

		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		mockZone := &citrixorchestration.ZoneDetailResponseModel{
			Id:        nameOrId,
			Name:      "Custom Zone",
			IsPrimary: true,
		}

		callCount := 0
		mockAPI.On("ZonesGetZoneExecute", mock.Anything).
			Run(func(args mock.Arguments) {
				// Custom logic executed when method is called
				callCount++
				// Can inspect args here and perform custom validations
				_ = args.Get(0).(citrixorchestration.ApiZonesGetZoneRequest)
			}).
			Return(mockZone, &http.Response{StatusCode: 200}, nil).Once()

		resp, httpRes, err := mockAPI.ZonesGetZone(context.Background(), nameOrId).Execute()

		require.Nil(t, err)
		require.NotNil(t, resp)
		assert.Equal(t, 200, httpRes.StatusCode)
		assert.Equal(t, 1, callCount, "Expected method to be called exactly once")
	})

	t.Run("Test ZonesGetZone Without Specific Expectations", func(t *testing.T) {
		// Demonstrates Maybe() for optional calls
		nameOrId := "maybe-zone"

		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		mockZone := &citrixorchestration.ZoneDetailResponseModel{
			Id:   nameOrId,
			Name: nameOrId,
		}

		// This expectation may or may not be called
		mockAPI.On("ZonesGetZoneExecute", mock.Anything).
			Return(mockZone, &http.Response{StatusCode: 200}, nil).Maybe()

		// Test passes even if we don't call the method
		// (useful for testing conditional code paths)
	})

	t.Run("Test ZonesCreateZone Success (POST)", func(t *testing.T) {
		// Demonstrates POST/Create operation testing
		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		createModel := citrixorchestration.NewCreateZoneRequestModel("New Zone")
		createModel.SetDescription("A new zone")

		expectedZone := &citrixorchestration.ZoneDetailResponseModel{
			Id:        "zone-123",
			Name:      "New Zone",
			IsPrimary: false,
		}
		expectedZone.SetDescription("A new zone")

		// Mock the create operation
		mockAPI.On("ZonesCreateZoneExecute", mock.MatchedBy(func(req citrixorchestration.ApiZonesCreateZoneRequest) bool {
			// Validate the request body contains expected data
			mockReq := citrixorchestration.MockApiZonesCreateZoneRequest{ApiZonesCreateZoneRequest: req}
			body := mockReq.GetCreateZoneRequestModel()
			return body.Name == "New Zone" && body.GetDescription() == "A new zone"
		})).Return(&http.Response{StatusCode: 201}, nil).Once()

		// Execute
		httpRes, err := mockAPI.ZonesCreateZone(context.Background()).
			CreateZoneRequestModel(*createModel).
			Execute()

		// Assert
		require.Nil(t, err)
		require.NotNil(t, httpRes)
		assert.Equal(t, 201, httpRes.StatusCode)
	})

	t.Run("Test ZonesEditZone Async Response (PATCH)", func(t *testing.T) {
		// Demonstrates handling async 202 responses with job polling
		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		zoneId := "zone-123"
		updateModel := citrixorchestration.NewEditZoneRequestModel()
		updateModel.SetName("Updated Zone")

		// Mock async 202 response with Location header containing job ID
		asyncResponse := &http.Response{
			StatusCode: 202,
			Header: http.Header{
				"Location": []string{"/jobs/job-456"},
			},
		}

		// Mock the update operation returning async response
		mockAPI.On("ZonesEditZoneExecute", mock.Anything).
			Return(asyncResponse, nil).Once()

		// Execute
		httpRes, err := mockAPI.ZonesEditZone(context.Background(), zoneId).
			EditZoneRequestModel(*updateModel).
			Async(true).
			Execute()

		// Assert async response
		require.Nil(t, err)
		assert.Equal(t, 202, httpRes.StatusCode)
		assert.Contains(t, httpRes.Header.Get("Location"), "job-456")
	})

	t.Run("Test ZonesDeleteZone Success (DELETE)", func(t *testing.T) {
		// Demonstrates DELETE operation testing
		mockClient := citrixorchestration.NewMockAPIClient()
		defer mockClient.AssertExpectations(t)
		mockAPI := citrixorchestration.GetMockZonesAPIsDAAS(mockClient.APIClient)

		zoneId := "zone-123"

		// Mock successful delete (typically returns 204 No Content)
		mockAPI.On("ZonesDeleteZoneExecute", mock.MatchedBy(func(req citrixorchestration.ApiZonesDeleteZoneRequest) bool {
			mockReq := citrixorchestration.MockApiZonesDeleteZoneRequest{ApiZonesDeleteZoneRequest: req}
			return mockReq.GetNameOrId() == zoneId
		})).Return(&http.Response{StatusCode: 204}, nil).Once()

		// Execute
		httpRes, err := mockAPI.ZonesDeleteZone(context.Background(), zoneId).Execute()

		// Assert
		require.Nil(t, err)
		require.NotNil(t, httpRes)
		assert.Equal(t, 204, httpRes.StatusCode)
	})
}
